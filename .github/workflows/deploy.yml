name: Deploy to Production

on:
  push:
    branches:
      - "main"
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"

jobs:
  build:
    uses: ./.github/workflows/reusable-build.yml
    with:
      artifact-name: build.tgz
      build-command: npm run build
      artifact-retention-days: 1

  deploy:
    needs: build
    uses: ./.github/workflows/reusable-deploy-s3.yml
    with:
      artifact-name: build.tgz
      s3-bucket: birds-eye-pages
      build-dir: ./build
      additional-files: robots.txt
      aws-region: ap-northeast-1
    secrets: inherit

  invalidate-cache:
    needs: deploy
    uses: ./.github/workflows/reusable-invalidate-cloudfront.yml
    with:
      paths: "/*"
      aws-region: ap-northeast-1
    secrets: inherit
